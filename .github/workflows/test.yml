name: ÎπåÎìú ÌÖåÏä§Ìä∏
#PR Îã®Í≥ÑÏóêÏÑú Îã®Ïàú ÏΩîÎìú ÌÖåÏä§Ìä∏Ïö©, ÌÖåÏä§Ìä∏Î•º ÌÜµÍ≥ºÌïòÏßÄ Î™ªÌïúÎã§Î©¥ merge Î∂àÍ∞Ä
on:
    pull_request:
        branches:
            - release
            - dev

permissions:
    pull-requests: write

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: JDK ÏÑ§Ïπò
              uses: actions/setup-java@v4
              with:
                  java-version: 17
                  distribution: temurin

            - name: Gradle Ï∫êÏãú Ï†ÅÏö©
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle/wrapper/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle

            #      - name: .env ÌååÏùº ÏÉùÏÑ±
            #        run: echo "${{ secrets.DOTENV }}" > .env

            - name: Set Yaml
              uses: cschleiden/replace-tokens@v1
              with:
                  tokenPrefix: "${"
                  tokenSuffix: "}"
                  files: '["./src/main/resources/application.yml"]'
              env:
                SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
                SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
                SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
                BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
                AWS_REGION: ${{ secrets.AWS_REGION }}
                AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
                JWT_SECRET: ${{ secrets.JWT_SECRET }}
                OAUTH_GOOGLE_CLIENT_ID: ${{ secrets.OAUTH_GOOGLE_CLIENT_ID }}
                OAUTH_GOOGLE_CLIENT_SECRET: ${{ secrets.OAUTH_GOOGLE_CLIENT_SECRET }}
                OAUTH_GOOGLE_REDIRECT_URL: ${{ secrets.OAUTH_GOOGLE_REDIRECT_URL }}
                OAUTH_KAKAO_CLIENT_ID: ${{ secrets.OAUTH_KAKAO_CLIENT_ID }}

            - name: ÌÖåÏä§Ìä∏ Î∞è ÎπåÎìúÌïòÍ∏∞
              run: |
                  chmod +x gradlew
                  ./gradlew clean build

            - name: ÌÖåÏä§Ìä∏ Ïª§Î≤ÑÎ¶¨ÏßÄÎ•º PRÏóê ÏΩîÎ©òÌä∏Î°ú Îì±Î°ù
              id: jacoco
              uses: madrapps/jacoco-report@v1.2
              with:
                  title: üìù ÌÖåÏä§Ìä∏ Ïª§Î≤ÑÎ¶¨ÏßÄ Î¶¨Ìè¨Ìä∏ÏûÖÎãàÎã§
                  paths: ${{ github.workspace }}/build/jacoco/test/jacocoTestReport.xml
                  token: ${{ secrets.GITHUB_TOKEN }}
                  min-coverage-overall: 50
                  min-coverage-changed-files: 50
