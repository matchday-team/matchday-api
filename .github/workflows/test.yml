name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
#PR ë‹¨ê³„ì—ì„œ ë‹¨ìˆœ ì½”ë“œ í…ŒìŠ¤íŠ¸ìš©, í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•˜ì§€ ëª»í•œë‹¤ë©´ merge ë¶ˆê°€
on:
    pull_request:
        branches:
            - release
            - main

permissions:
  pull-requests: write

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: JDK ì„¤ì¹˜
              uses: actions/setup-java@v4
              with:
                  java-version: 17
                  distribution: temurin

            - name: Gradle ìºì‹œ ì ìš©
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle/wrapper/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle

            #      - name: .env íŒŒì¼ ìƒì„±
            #        run: echo "${{ secrets.DOTENV }}" > .env

            - name: Set Yaml
              uses: cschleiden/replace-tokens@v1
              with:
                  tokenPrefix: "${"
                  tokenSuffix: "}"
                  files: '["./src/main/resources/application.yml"]'
              env:
                  SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
                  SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
                  SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
                  BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
                  AWS_REGION: ${{ secrets.AWS_REGION }}
                  AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
                  AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}

            - name: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œí•˜ê¸°
              run: |
                  chmod +x gradlew
                  ./gradlew clean build

            - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ë¥¼ PRì— ì½”ë©˜íŠ¸ë¡œ ë“±ë¡
              id: jacoco
              uses: madrapps/jacoco-report@v1.2
              with:
                  title: ğŸ“ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤
                  paths: ${{ github.workspace }}/build/jacoco/test/jacocoTestReport.xml
                  token: ${{ secrets.GITHUB_TOKEN }}
                  min-coverage-overall: 50
                  min-coverage-changed-files: 50
